<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ðŸ“… MIP Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSV + date parsing libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;margin:24px;}
    table{border-collapse:collapse;width:100%;table-layout:fixed}
    th,td{border:1px solid #e5e7eb}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
    tbody th{background:#fff}
    .container{overflow:auto;max-width:100%}
    .controls>*{margin-right:12px}
    #q{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px}
    .chip{padding:4px 8px;border-radius:8px;margin-left:8px;display:inline-block}
    .panel{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:8px 0 16px 0;background:#fafafa}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input[type="text"]{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}

    /* === Solid full-width separator between students === */
    tbody tr.student-divider td {
      padding: 0 !important;
      border: none !important;
      height: 6px;             /* thickness of the bar */
      background: #94a3b8;     /* slate-400 solid bar */
    }
  </style>
</head>
<body>
  <h1>ðŸ“… MIP Calendar</h1>
  <p><strong>Rows:</strong> Name &amp; Subject (separate columns) &nbsp;&nbsp;
     <strong>Columns:</strong> Date &nbsp;&nbsp;
     <strong>Cells:</strong> MIP (or <em>Absent</em>)</p>
  <div style="margin:8px 0 16px 0;">
    <strong>Legend:</strong>
    <span class="chip" style="background:#A5D6A7;">On Track</span>
    <span class="chip" style="background:#FFF59D;">Spend More Time</span>
    <span class="chip" style="background:#EF9A9A;">Low Efficiency / Idling</span>
    <span class="chip" style="background:#CFD8DC;">Absent</span>
    <span class="chip" style="background:#EEEEEE;">No Data</span>
  </div>

  <!-- Mapping panel -->
  <div class="panel">
    <div class="row">
      <div>
        <label>MIP CSV:</label>
        <input id="mipFileName" value="mip.csv" style="width:180px"/>
      </div>
      <div>
        <label>Absent CSV (optional):</label>
        <input id="absFileName" value="absent.csv" style="width:180px"/>
      </div>
      <button id="reload">Load CSVs</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Name column:</label><select id="nameCol"></select></div>
      <div><label>Subject column:</label><select id="subjCol"></select></div>
      <div><label>MIP column:</label><select id="mipCol"></select></div>
      <div><label>Date column:</label><select id="dateCol"></select></div>
      <div>
        <label>Date format:</label>
        <select id="dateFmt">
          <option value="auto">Auto detect</option>
          <option value="DD/MM/YY" selected>DD/MM/YY (e.g. 31/08/25)</option>
          <option value="DD/MM/YYYY">DD/MM/YYYY</option>
          <option value="MM/DD/YYYY">MM/DD/YYYY</option>
          <option value="YYYY-MM-DD">YYYY-MM-DD</option>
          <option value="DD-MM-YYYY">DD-MM-YYYY</option>
          <option value="YYYY/MM/DD">YYYY/MM/DD</option>
        </select>
      </div>
      <button id="build">Build Calendar</button>
    </div>
  </div>

  <div class="controls" style="margin:8px 0 12px 0;">
    <label>Search:</label> <input id="q" placeholder="Type name or subject..." />
  </div>
  <div id="subjects"></div>

  <div class="container" style="margin-top:8px;">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <p id="status" style="margin-top:12px;color:#64748b;"></p>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);

const COLOR = { onTrack:'#A5D6A7', spendMore:'#FFF59D', red:'#EF9A9A', absent:'#CFD8DC', none:'#EEEEEE' };
const HOVER_INDICES = [4,5,6,7,8,9,12]; // E..J & M

let mipRows = [], absRows = [], allCols = [];
const els = {
  nameCol:document.getElementById('nameCol'), subjCol:document.getElementById('subjCol'),
  mipCol:document.getElementById('mipCol'),   dateCol:document.getElementById('dateCol'),
  dateFmt:document.getElementById('dateFmt'), thead:document.getElementById('thead'),
  tbody:document.getElementById('tbody'),     q:document.getElementById('q'),
  status:document.getElementById('status'),   subjects:document.getElementById('subjects'),
  mipFileName:document.getElementById('mipFileName'), absFileName:document.getElementById('absFileName')
};

/* ---------- CSV loader (fixed) ---------- */
const parseCSV = async (url) => {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
  const text = await res.text();
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: (result) => resolve(result.data),
      error: reject
    });
  });
};

const findCol = (rows, candidates) => {
  if (!rows.length) return null;
  const cols = Object.keys(rows[0]);
  for (const cand of candidates) {
    const hit = cols.find(c => c.toLowerCase() === cand.toLowerCase());
    if (hit) return hit;
  }
  for (const cand of candidates) {
    const hit = cols.find(c => c.toLowerCase().includes(cand.toLowerCase()));
    if (hit) return hit;
  }
  return null;
};

const toISODate = (v, fmt) => {
  if (!v) return null;
  if (fmt && fmt !== 'auto') {
    const d = dayjs(v, fmt, true);
    return d.isValid() ? d.format('YYYY-MM-DD') : null;
  }
  // auto: common 4-digit + 2-digit patterns
  let d = dayjs(v);
  if (!d.isValid()) d = dayjs(v, 'DD/MM/YY', true);
  if (!d.isValid()) d = dayjs(v, 'DD/MM/YYYY', true);
  if (!d.isValid()) d = dayjs(v, 'MM/DD/YYYY', true);
  if (!d.isValid()) d = dayjs(v, 'YYYY-MM-DD', true);
  if (!d.isValid()) d = dayjs(v, 'DD-MM-YYYY', true);
  if (!d.isValid()) d = dayjs(v, 'YYYY/MM/DD', true);
  return d.isValid() ? d.format('YYYY-MM-DD') : null;
};

const statusColor = (val) => {
  if (val == null || val === "") return COLOR.none;
  const s = String(val).trim().toLowerCase();
  if (s.includes("on track")) return COLOR.onTrack;
  if (s.includes("spend more")) return COLOR.spendMore;
  if (s.includes("low efficiency") || s.includes("probable") || s.includes("idling") || s.includes("inflated")) return COLOR.red;
  return COLOR.none;
};

const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ---------- Load CSVs & guess columns ---------- */
async function loadCSVs() {
  els.status.textContent = 'Loading...';
  try { mipRows = await parseCSV(els.mipFileName.value.trim()); els.status.textContent = 'Loaded ' + els.mipFileName.value.trim(); }
  catch (e) { els.status.textContent = 'Could not load ' + els.mipFileName.value.trim(); mipRows = []; }

  try { absRows = await parseCSV(els.absFileName.value.trim()); els.status.textContent += ' + ' + els.absFileName.value.trim(); }
  catch { absRows = []; }

  if (!mipRows.length) return;

  allCols = Object.keys(mipRows[0]);
