<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ðŸ“… MIP Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <style>
    :root { --nameW: 200px; --subjW: 160px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 24px; color: #0f172a; }

    .scroll-wrapper { overflow-x: auto; overflow-y: hidden; width: 100%; }
    .table-container { position: relative; min-width: max-content; }
    table { border-collapse: collapse; width: auto; table-layout: auto; }

    th, td { border: 1px solid #e5e7eb; }
    thead th { position: sticky; top: 0; background: #f8fafc; z-index: 3; }

    thead th.name, tbody th.name { position: sticky; left: 0; min-width: var(--nameW); width: var(--nameW); background: #f8fafc; z-index: 5; }
    thead th.subj, tbody th.subj { position: sticky; left: var(--nameW); min-width: var(--subjW); width: var(--subjW); background: #f8fafc; z-index: 5; border-right: 2px solid #e2e8f0; }

    td { text-align: center; min-width: 90px; padding: 6px 8px; }
    /* Readable status pills */
    .pill { display:inline-flex; align-items:center; justify-content:center; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; line-height:1.1; background: rgba(255,255,255,0.7); max-width: 84px; text-align:center; white-space: normal; word-break: break-word; }
    .chip { padding: 4px 8px; border-radius: 8px; margin-left: 8px; display: inline-block; }
    .panel { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin: 8px 0 16px 0; background: #fafafa; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    select, input[type="text"], input[type="number"] { padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
    button { padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; cursor: pointer; }
    .muted { color: #64748b; }
  </style>
</head>
<body>
  <h1>ðŸ“… MIP Calendar</h1>
  <p><strong>Rows:</strong> Name &amp; Subject &nbsp;&nbsp;<strong>Columns:</strong> Date &nbsp;&nbsp;<strong>Cells:</strong> MIP</p>

  <div class="panel">
    <div class="row">
      <label>MIP CSV:</label><input id="mipFileName" value="mip.csv" style="width:180px"/>
      <label>Absent CSV:</label><input id="absFileName" value="absent.csv" style="width:180px"/>
      <button id="reload">Load CSVs</button>
    </div>
    <div class="row" style="margin-top:10px">
      <label>Name column:</label><select id="nameCol"></select>
      <label>Subject column:</label><select id="subjCol"></select>
      <label>MIP column:</label><select id="mipCol"></select>
      <label>Date column:</label><select id="dateCol"></select>
      <label>Date format:</label>
      <select id="dateFmt">
        <option value="auto">Auto detect</option>
        <option value="DD/MM/YY" selected>DD/MM/YY</option>
        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
      </select>
      <label>Sticky widths:</label>
      <input id="nameW" type="number" value="200" style="width:80px"> px
      <input id="subjW" type="number" value="160" style="width:80px"> px
      <button id="build">Build Calendar</button>
    </div>
  </div>

  <div class="scroll-wrapper">
    <div class="table-container">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <p id="status" class="muted"></p>

  <script>
    dayjs.extend(dayjs_plugin_customParseFormat);
    const COLOR = { onTrack:'#A5D6A7', spendMore:'#FFF59D', red:'#EF9A9A', absent:'#CFD8DC', none:'#EEEEEE' };
    let mipRows = [], absRows = [];
    const els = {
      nameCol: document.getElementById('nameCol'), subjCol: document.getElementById('subjCol'), mipCol: document.getElementById('mipCol'), dateCol: document.getElementById('dateCol'),
      dateFmt: document.getElementById('dateFmt'), thead: document.getElementById('thead'), tbody: document.getElementById('tbody'),
      status: document.getElementById('status'), mipFileName: document.getElementById('mipFileName'), absFileName: document.getElementById('absFileName'),
      nameW: document.getElementById('nameW'), subjW: document.getElementById('subjW')
    };

    const parseCSV = async (url) => {
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`Failed ${url}`);
      const text = await res.text();
      return new Promise((resolve) => {
        Papa.parse(text, {header:true, skipEmptyLines:true, complete: r=>resolve(r.data)});
      });
    };

    const findCol = (rows, candidates) => {
      if (!rows.length) return null;
      const cols = Object.keys(rows[0]);
      for (const c of candidates) { const hit = cols.find(k=>k.toLowerCase().includes(c.toLowerCase())); if (hit) return hit; }
      return cols[0];
    };

    const toISO = (v, fmt) => {
      if (!v) return null; let d = fmt==='auto'?dayjs(v):dayjs(v,fmt,true); return d.isValid()?d.format('YYYY-MM-DD'):null;
    };

    const color = (v)=>{
      if(!v) return COLOR.none; const s=String(v).toLowerCase();
      if(s.includes('on track')) return COLOR.onTrack;
      if(s.includes('spend')||s.includes('more time')) return COLOR.spendMore;
      if(s.includes('efficiency')||s.includes('idle')||s.includes('inflated')) return COLOR.red;
      return COLOR.none;
    };

    const abbr = (v)=>{
      if(!v) return '';
      const s=String(v).toLowerCase();
      if(s.includes('on track')) return 'On
Track';
      if(s.includes('spend')||s.includes('more time')) return 'Spend
More
Time';
      if(s.includes('probable')||s.includes('inflated')) return 'Probable
Idling/
Inflated
Time';
      if(s.includes('efficiency')) return 'Low
Efficiency';
      if(s.includes('no work')) return 'No
Work';
      return v;
    };

    async function loadCSVs(){
      try{ mipRows=await parseCSV(els.mipFileName.value);}catch{mipRows=[];}
      try{ absRows=await parseCSV(els.absFileName.value);}catch{absRows=[];}
      if(!mipRows.length){els.status.textContent='No MIP data';return;}
      const cols=Object.keys(mipRows[0]);
      const name=findCol(mipRows,['name']), subj=findCol(mipRows,['subject']), mip=findCol(mipRows,['mip','status']), date=findCol(mipRows,['date']);
      for(const sel of [els.nameCol,els.subjCol,els.mipCol,els.dateCol]){ sel.innerHTML=''; cols.forEach(c=>sel.innerHTML+=`<option value="${c}">${c}</option>`);} 
      els.nameCol.value=name; els.subjCol.value=subj; els.mipCol.value=mip; els.dateCol.value=date;
    }

    function buildCalendar(){
      document.documentElement.style.setProperty('--nameW', els.nameW.value+'px');
      document.documentElement.style.setProperty('--subjW', els.subjW.value+'px');
      const fmt=els.dateFmt.value; const nameC=els.nameCol.value, subjC=els.subjCol.value, mipC=els.mipCol.value, dateC=els.dateCol.value;
      const rows=mipRows.map(r=>{const d=toISO(r[dateC],fmt);if(!d)return null;return{n:r[nameC],s:r[subjC],m:r[mipC],d};}).filter(Boolean);
      const dates=[...new Set(rows.map(r=>r.d))].sort(); const keys=[...new Set(rows.map(r=>JSON.stringify([r.n,r.s])))]
      const map=new Map(); rows.forEach(r=>map.set(JSON.stringify([r.n,r.s,r.d]),r.m));
      els.thead.innerHTML='<tr><th class="name">Name</th><th class="subj">Subject</th>'+dates.map(d=>`<th>${d}</th>`).join('')+'</tr>';
      els.tbody.innerHTML='';
      const frag=document.createDocumentFragment(); let prev=null;
      for(const key of keys){let [n,s]=JSON.parse(key);const tr=document.createElement('tr');if(prev&&prev!==n)tr.style.borderTop='3px solid #94a3b8';prev=n;
        const th1=document.createElement('th');th1.className='name';th1.textContent=n;const th2=document.createElement('th');th2.className='subj';th2.textContent=s;tr.append(th1,th2);
        for(const d of dates){
          const td=document.createElement('td');
          const val=map.get(JSON.stringify([n,s,d]));
          td.style.background=color(val);
          if(val){ td.innerHTML = `<span class="pill" title="${String(val).replace(/"/g,'&quot;')}">${abbr(val)}</span>`; }
          else { td.textContent=''; }
          tr.append(td);
        }frag.append(tr);}
      els.tbody.append(frag);
      els.status.textContent=`Built ${dates.length} columns Ã— ${keys.length} rows`;
    }

    document.getElementById('reload').onclick=loadCSVs;
    document.getElementById('build').onclick=buildCalendar;
    loadCSVs();
  </script>
</body>
</html>
