<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ðŸ“… MIP Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;margin:24px;}
    table{border-collapse:collapse;width:100%;table-layout:fixed}
    th,td{border:1px solid #e5e7eb}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
    tbody th{background:#fff}
    .container{overflow:auto;max-width:100%}
    .controls>*{margin-right:12px}
    #q{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px}
    .chip{padding:4px 8px;border-radius:8px;margin-left:8px;display:inline-block}
    .panel{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:8px 0 16px 0;background:#fafafa}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input[type="text"]{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:6px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}

    /* === Solid full-width separator between students === */
    tbody tr.student-divider td {
      padding: 0 !important;
      border: none !important;
      height: 6px;             /* thickness */
      background: #94a3b8;     /* slate gray solid bar */
    }
  </style>
</head>
<body>
  <h1>ðŸ“… MIP Calendar</h1>
  <p><strong>Rows:</strong> Name &amp; Subject (separate columns) &nbsp;&nbsp;
     <strong>Columns:</strong> Date &nbsp;&nbsp;
     <strong>Cells:</strong> MIP (or <em>Absent</em>)</p>
  <div style="margin:8px 0 16px 0;">
    <strong>Legend:</strong>
    <span class="chip" style="background:#A5D6A7;">On Track</span>
    <span class="chip" style="background:#FFF59D;">Spend More Time</span>
    <span class="chip" style="background:#EF9A9A;">Low Efficiency / Idling</span>
    <span class="chip" style="background:#CFD8DC;">Absent</span>
    <span class="chip" style="background:#EEEEEE;">No Data</span>
  </div>

  <!-- Mapping panel -->
   <div class="panel">
    <div class="row">
      <div>
        <label>MIP CSV:</label>
        <input id="mipFileName" value="mip.csv" style="width:180px"/>
      </div>
      <div>
        <label>Absent CSV (optional):</label>
        <input id="absFileName" value="absent.csv" style="width:180px"/>
      </div>
      <button id="reload">Load CSVs</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Name column:</label><select id="nameCol"></select></div>
      <div><label>Subject column:</label><select id="subjCol"></select></div>
      <div><label>MIP column:</label><select id="mipCol"></select></div>
      <div><label>Date column:</label><select id="dateCol"></select></div>
      <div>
        <label>Date format:</label>
        <select id="dateFmt">
          <option value="auto">Auto detect</option>
          <option value="DD/MM/YY" selected>DD/MM/YY (e.g. 31/08/25)</option>
          <option value="DD/MM/YYYY">DD/MM/YYYY</option>
          <option value="MM/DD/YYYY">MM/DD/YYYY</option>
          <option value="YYYY-MM-DD">YYYY-MM-DD</option>
          <option value="DD-MM-YYYY">DD-MM-YYYY</option>
          <option value="YYYY/MM/DD">YYYY/MM/DD</option>
        </select>
      </div>
      <button id="build">Build Calendar</button>
    </div> 
  </div>

  <div class="controls" style="margin:8px 0 12px 0;">
    <label>Search:</label> <input id="q" placeholder="Type name or subject..." />
  </div>
  <div id="subjects"></div>

  <div class="container" style="margin-top:8px;">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <p id="status" style="margin-top:12px;color:#64748b;"></p>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);
const COLOR = { onTrack:'#A5D6A7', spendMore:'#FFF59D', red:'#EF9A9A', absent:'#CFD8DC', none:'#EEEEEE' };
const HOVER_INDICES = [4,5,6,7,8,9,12];
let mipRows=[],absRows=[],allCols=[];
const els={
  nameCol:document.getElementById('nameCol'),subjCol:document.getElementById('subjCol'),
  mipCol:document.getElementById('mipCol'),dateCol:document.getElementById('dateCol'),
  dateFmt:document.getElementById('dateFmt'),thead:document.getElementById('thead'),
  tbody:document.getElementById('tbody'),q:document.getElementById('q'),
  status:document.getElementById('status'),subjects:document.getElementById('subjects'),
  mipFileName:document.getElementById('mipFileName'),absFileName:document.getElementById('absFileName')
};

const parseCSV=async(url)=>{const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error('fetch '+url);
  return new Promise((res,rej)=>Papa.parse(await r.text(),{header:true,skipEmptyLines:true,complete:v=>res(v.data),error:rej}));
};
const findCol=(rows,cands)=>{if(!rows.length)return null;const cols=Object.keys(rows[0]);
  for(const c of cands){const hit=cols.find(x=>x.toLowerCase()===c.toLowerCase());if(hit)return hit;}
  for(const c of cands){const hit=cols.find(x=>x.toLowerCase().includes(c.toLowerCase()));if(hit)return hit;}return null;
};
const toISODate=(v,f)=>{if(!v)return null;if(f&&f!=='auto'){const d=dayjs(v,f,true);return d.isValid()?d.format('YYYY-MM-DD'):null;}
  let d=dayjs(v);if(!d.isValid())d=dayjs(v,'DD/MM/YY',true);if(!d.isValid())d=dayjs(v,'DD/MM/YYYY',true);
  if(!d.isValid())d=dayjs(v,'MM/DD/YYYY',true);if(!d.isValid())d=dayjs(v,'YYYY-MM-DD',true);if(!d.isValid())d=dayjs(v,'DD-MM-YYYY',true);
  if(!d.isValid())d=dayjs(v,'YYYY/MM/DD',true);return d.isValid()?d.format('YYYY-MM-DD'):null;
};
const statusColor=v=>{
  if(!v)return COLOR.none;
  const s=String(v).toLowerCase();
  if(s.includes('on track'))return COLOR.onTrack;
  if(s.includes('spend'))return COLOR.spendMore;
  if(s.includes('low efficiency')||s.includes('probable')||s.includes('idling')||s.includes('inflated'))return COLOR.red;
  return COLOR.none;
};
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
async function loadCSVs(){
  els.status.textContent='Loading...';
  try{mipRows=await parseCSV(els.mipFileName.value.trim());els.status.textContent='Loaded MIP';}catch(e){els.status.textContent='MIP load fail';}
  try{absRows=await parseCSV(els.absFileName.value.trim());}catch{absRows=[];}
  if(!mipRows.length)return;
  allCols=Object.keys(mipRows[0]);
  const guess={name:findCol(mipRows,['name','student']),subj:findCol(mipRows,['subject','class']),
    mip:findCol(mipRows,['mip','status']),date:findCol(mipRows,['date','day'])};
  const fill=(sel,allowEmpty=false)=>{sel.innerHTML=allowEmpty?'<option value="">(none)</option>':'';for(const c of allCols)sel.innerHTML+=`<option value="${esc(c)}">${esc(c)}</option>`};
  fill(els.nameCol);fill(els.subjCol,true);fill(els.mipCol);fill(els.dateCol);
  els.nameCol.value=guess.name;els.subjCol.value=guess.subj;els.mipCol.value=guess.mip;els.dateCol.value=guess.date;
}
function buildCalendar(){
  const nameCol=els.nameCol.value,subjCol=els.subjCol.value||null,mipCol=els.mipCol.value,dateCol=els.dateCol.value,fmt=els.dateFmt.value;
  if(!mipRows.length){els.status.textContent='Load CSVs first';return;}
  const rows=mipRows.map(r=>{const iso=toISODate(r[dateCol],fmt);if(!iso)return null;
    const key=subjCol?JSON.stringify([r[nameCol],r[subjCol]]):r[nameCol];
    return{__date:iso,__row:key,__name:r[nameCol],__subj:subjCol?r[subjCol]:'',__mip:r[mipCol],_raw:r};}).filter(Boolean);
  if(!rows.length){els.status.textContent='No valid dates';return;}
  const map=new Map();rows.forEach(r=>map.set(r.__row+'|'+r.__date,r));
  const dedup=Array.from(map.values());
  const absPairs=new Set(),absNameDate=new Set();
  if(absRows.length){const aName=findCol(absRows,[els.nameCol.value,'name'])||Object.keys(absRows[0])[0];
    const aSubj=subjCol?findCol(absRows,[els.subjCol.value,'subject']):null;
    const aDate=findCol(absRows,['date'])||els.dateCol.value;
    absRows.forEach(r=>{const iso=toISODate(r[aDate],fmt)||toISODate(r[aDate],'auto');
      const flag=String(r.absent||r.status||'absent').toLowerCase();
      const absent=['absent','a','1','true','yes'].includes(flag);
      if(!iso||!absent)return;
      if(aSubj){const k=JSON.stringify([r[aName],r[aSubj]]);absPairs.add(JSON.stringify([k,iso]));}
      else absNameDate.add(JSON.stringify([r[aName],iso]));
    });
  }
  const rowKeys=Array.from(new Set(dedup.map(r=>r.__row)));
  const dates=Array.from(new Set(dedup.map(r=>r.__date))).sort();
  const valMap=new Map(),tipMap=new Map();
  dedup.forEach(r=>{const k=r.__row+'|'+r.__date;valMap.set(k,r.__mip);
    const t=HOVER_INDICES.map(i=>allCols[i]?`${allCols[i]}: ${r._raw[allCols[i]]??''}`:'').join('\n');tipMap.set(k,t);});
  els.thead.innerHTML='';const trh=document.createElement('tr');
  trh.innerHTML=`<th style="position:sticky;left:0;background:#fafafa;z-index:3;">Name</th>
                 <th style="position:sticky;left:120px;background:#fafafa;z-index:3;">Subject</th>`+
                 dates.map(d=>`<th>${d}</th>`).join('');
  els.thead.appendChild(trh);
  els.tbody.innerHTML='';const subjects=new Set();let prevName=null;
  rowKeys.forEach(rk=>{
    let name=rk,subject='';try{const a=JSON.parse(rk);name=a[0];subject=a[1]||'';}catch{}
    if(subject)subjects.add(subject);
    if(prevName!==null&&name!==prevName){ // divider row
      const div=document.createElement('tr');
      div.className='student-divider';
      const td=document.createElement('td');
      td.colSpan=2+dates.length;
      div.appendChild(td);
      els.tbody.appendChild(div);
    }
    prevName=name;
    const tr=document.createElement('tr');
    tr.setAttribute('data-subject',subject||'');
    const th1=document.createElement('th');th1.style.position='sticky';th1.style.left='0';th1.style.background='#fff';th1.textContent=name;
    const th2=document.createElement('th');th2.style.position='sticky';th2.style.left='120px';th2.style.background='#fff';th2.textContent=subject;
    tr.append(th1,th2);
    dates.forEach(d=>{
      const td=document.createElement('td');
      td.style.textAlign='center';td.style.minWidth='90px';td.style.padding='6px 8px';
      const k=rk+'|'+d;
      const tip=tipMap.get(k);if(tip)td.title=tip;
      const isAbs=absPairs.has(JSON.stringify([rk,d]))||absNameDate.has(JSON.stringify([name,d]));
      if(isAbs){td.style.background=COLOR.absent;td.textContent='Absent';}
      else{const v=valMap.get(k);td.style.background=statusColor(v);td.textContent=v||'';}
      tr.appendChild(td);
    });
    els.tbody.appendChild(tr);
  });
  // subject filters
  els.subjects.innerHTML='';
  const subjList=Array.from(subjects).sort();
  if(subjList.length){
    const wrap=document.createElement('div');wrap.style.marginTop='6px';
    wrap.innerHTML='<strong>Subjects:</strong> '+subjList.map(s=>`<label style="margin-right:12px;"><input type="checkbox" class="subj" value="${esc(s)}" checked/> ${esc(s)}</label>`).join('')+
      `<button onclick="selectAllSubjects(true)" style="margin-left:8px;">Select All</button>
       <button onclick="selectAllSubjects(false)" style="margin-left:6px;">Clear</button>`;
    els.subjects.appendChild(wrap);
  }
  const filter=()=>{const q=(els.q.value||'').toLowerCase();
    const chk=document.querySelectorAll('input.subj');const sel=new Set();
    chk.forEach(b=>{if(b.checked)sel.add(b.value.toLowerCase());});
    document.querySelectorAll('tbody tr').forEach(tr=>{
      if(tr.classList.contains('student-divider'))return;
      const n=tr.children[0].textContent.toLowerCase();
      const s=(tr.getAttribute('data-subject')||'').toLowerCase();
      const show=( (!q||n.includes(q)||s.includes(q)) && (sel.has(s)||s==='') );
      tr.style.display=show?'':'none';
    });
  };
  window.selectAllSubjects=s=>{document.querySelectorAll('input.subj').forEach(b=>b.checked=s);filter();};
  els.q.oninput=filter;document.addEventListener('change',e=>{if(e.target.classList.contains('subj'))filter();});
  els.status.textContent=`Built ${dates.length} date columns Â· ${rowKeys.length} rows`;
}
document.getElementById('reload').onclick=loadCSVs;
document.getElementById('build').onclick=buildCalendar;
loadCSVs();
</script>
</body>
</html>
